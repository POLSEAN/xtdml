ml_l = learner$clone()
xtdml_lasso = xtdml_plr$new(obj_xtdml_data_lasso,
ml_l = ml_l, ml_m = ml_m,
score = "orth-PO",
n_folds = 3)
xtdml_lasso$fit()
#xtdml_lasso$print()
xtdml_lasso$summary()
#______________________________________________________________________________#
# nnet
#______________________________________________________________________________#
obj_xtdml_data_nnet = xtdml_data_from_data_frame(crime4,
x_cols = c(xvars,pvars),  y_col = yvar, d_cols = dvar,
panel_id = "county", time_id = "year",
approach = approach, transformX = "minmax")
print(obj_xtdml_data_nnet)
ml_l = lrn("regr.nnet", maxit=100, MaxNWts=1000, trace=FALSE)
ml_m = lrn("regr.nnet", maxit=100, MaxNWts=1000, trace=FALSE)
xtdml_nnet = xtdml_plr$new(obj_xtdml_data_nnet,
ml_l = ml_l, ml_m = ml_m,
score = "orth-PO",
n_folds = 3)
param_grid = list("ml_l" = ps(size = p_int(lower = 2, upper = 10),
decay = p_dbl(lower = 0, upper = 0.05)),
"ml_m" = ps(size = p_int(lower = 2, upper = 10),
decay = p_dbl(lower = 0, upper =  0.05)))
tune_settings = list(n_folds_tune = 3,
rsmp_tune  = mlr3::rsmp("cv", folds = 3),
terminator = mlr3tuning::trm("evals", n_evals = 10),
tuner      = tnr("grid_search", resolution = 10))
xtdml_nnet$tune(param_set = param_grid, tune_settings = tune_settings)
xtdml_nnet$fit()
#xtdml_nnet$print()
xtdml_nnet$summary()
#____________________________________________________________________________#
# Display table that compares results
#____________________________________________________________________________#
table = matrix(0, 8, 3)
table[,1] = cbind(xtdml_boost$coef_theta,
xtdml_boost$se_theta,
xtdml_boost$pval_theta,
xtdml_boost$model_rmse,
as.numeric(xtdml_boost$rmses["ml_l"]),
as.numeric(xtdml_boost$rmses["ml_m"]),
xtdml_boost$data$n_obs,
length(unique(xtdml_boost$data$data_model[[xtdml_boost$data$cluster_cols]])))
table[,2] = cbind(xtdml_lasso$coef_theta,
xtdml_lasso$se_theta,
xtdml_lasso$pval_theta,
xtdml_lasso$model_rmse,
as.numeric(xtdml_lasso$rmses["ml_l"]),
as.numeric(xtdml_lasso$rmses["ml_m"]),
xtdml_lasso$data$n_obs,
length(unique(xtdml_lasso$data$data_model[[xtdml_lasso$data$cluster_cols]])))
table[,3] = cbind(xtdml_nnet$coef_theta,
xtdml_nnet$se_theta,
xtdml_nnet$pval_theta,
xtdml_nnet$model_rmse,
as.numeric(xtdml_nnet$rmses["ml_l"]),
as.numeric(xtdml_nnet$rmses["ml_m"]),
xtdml_nnet$data$n_obs,
length(unique(xtdml_nnet$data$data_model[[xtdml_nnet$data$cluster_cols]])))
rownames(table)= c("Estimate", "Std. Error", "P-value", "Model RMSE", "MSE of l", "MSE of m",
"No. observations","No. groups")
colnames(table)= c("xtdml-Boosting", "xtdml-Lasso", "xtdml-Nnet")
print(round(table, 3))
toc()
}
#______________________________________________________________________________#
# Title:  Implementation of `xtdml` with simulated data
# Date: 01 October 2025
#______________________________________________________________________________#
rm(list = ls())
wd = "C:/Users/annal/Dropbox/IADS/dml/submissions/JSS"
setwd(wd)
wd.pack = "C:/Users/annal/Dropbox/IADS/dml/xtdml"
setwd(wd.pack)
devtools::load_all()
# Installation from CRAN
#install.packages("xtdml")
#library(xtdml)
# # Installation from GitHub
# library(devtools)
# install_github("POLSEAN/xtdml")
# library(xtdml)
#______________________________________________________________________________#
# # Install packages
# list.of.packages = c("mlr3","mlr3learners","mlr3tuning","paradox","mlr3misc",
#                       "glmnet","xgboost","tibble", "dplyr","datawizard","data.table",
#                       "glue","MLmetrics","devtools","tictoc")
# new.packages = list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
# if(length(new.packages)) install.packages(new.packages, repos = "http://cran.us.r-project.org")
library(mlr3)
library(mlr3learners)
library(paradox)
library(mlr3tuning)
library(mlr3misc)
library(xgboost)
library(tibble)
library(dplyr)
library(datawizard)
library(data.table)
library(tictoc)
# Suppress  messages
lgr::get_logger("mlr3")$set_threshold("warn")
lgr::get_logger("bbotk")$set_threshold("warn")
#______________________________________________________________________________#
# generate data
#______________________________________________________________________________#
set.seed(1234)
# Load data
df = make_plpr_data(n_obs = 1000, t_per = 10, dim_x = 20, theta = 0.5, rho=0.8)
approaches = c("fd-exact","cre", "wg-approx")
for (approach in approaches){
# Initialize data environment
x_cols = paste0("X", 1:20)
obj_xtdml_data = xtdml_data_from_data_frame(df,
x_cols = x_cols,  y_col = "y", d_cols = "d",
panel_id = "id", time_id = "time",
approach = approach, transformX = "no")
#print(obj_xtdml_data)
#______________________________________________________________________________#
# gradient boosting
#______________________________________________________________________________#
learner = lrn("regr.xgboost", nrounds = 10)
ml_m = learner$clone()
ml_l = learner$clone()
type_score = c("orth-PO", "orth-IV")
print(paste0("approach:", approach))
for (score in type_score){
tic(paste0(score, "-run"))
if(score == "orth-PO"){
xtdml_obj = xtdml_plr$new(obj_xtdml_data,
ml_l = ml_l, ml_m = ml_m,
n_folds = 5,
score = score,
dml_procedure = "dml2",
draw_sample_splitting = TRUE,
apply_cross_fitting = TRUE)
param_grid = list("ml_l" = ps(max_depth = p_int(2,10),
lambda = p_dbl(0,2)),
"ml_m" = ps(max_depth = p_int(2,10),
lambda = p_dbl(0,2)))
}else if (score == "orth-IV"){
ml_g = learner$clone()
xtdml_obj = xtdml_plr$new(obj_xtdml_data,
ml_l = ml_l, ml_m = ml_m, ml_g = ml_g,
n_folds = 5,
score = score,
dml_procedure = "dml2",
draw_sample_splitting = TRUE,
apply_cross_fitting = TRUE)
param_grid = list("ml_l" = ps(max_depth = p_int(2,10),
lambda = p_dbl(0,2)),
"ml_m" = ps(max_depth = p_int(2,10),
lambda = p_dbl(0,2)),
"ml_g" = ps(max_depth = p_int(2,10),
lambda = p_dbl(0,2)))
}
tune_settings = list(n_folds_tune = 5,
rsmp_tune = mlr3::rsmp("cv", folds = 5),
terminator = mlr3tuning::trm("evals", n_evals = 5),
tuner        = tnr("grid_search", resolution = 10))
xtdml_obj$tune(param_set = param_grid, tune_settings = tune_settings)
# Fit DML model and print results
xtdml_obj$fit()
xtdml_obj$print()
xtdml_obj$summary()
ci = xtdml_obj$confint()
print(ci)
toc()
}
print(xtdml_obj$params)
table = matrix(0, 10, 1)
table[,1] = cbind(xtdml_obj$coef_theta,
xtdml_obj$se_theta,
xtdml_obj$pval_theta,
ci[ , 1], ci[ , 2],
xtdml_obj$model_rmse,
as.numeric(xtdml_obj$rmses["ml_l"]),
as.numeric(xtdml_obj$rmses["ml_m"]),
xtdml_obj$data$n_obs,
length(unique(xtdml_obj$data$data_model[[xtdml_obj$data$cluster_cols]])))
rownames(table)= c("Estimate", "Std. Error", "P-value", "Lower bound 95% CI", "Upper bound 95% CI",
"Model RMSE", "MSE of l", "MSE of m","No. observations","No. groups")
colnames(table)= c("xtdml-boosting")
formatted_table = matrix("", nrow=10, ncol=1)
formatted_table[1:8, 1] = formatC(table[1:8, 1], digits=4, format="f")
formatted_table[9:10, 1] = formatC(table[9:10, 1], digits=0, format="f")
# Keep row and column names
rownames(formatted_table) = rownames(table)
colnames(formatted_table) = colnames(table)
# Print
print(formatted_table, quote = FALSE)
}
rm(list = ls())
wd = "C:/Users/annal/Dropbox/IADS/dml"
setwd(wd)
wd.pack = "C:/Users/annal/Dropbox/IADS/dml/xtdml"
setwd(wd.pack)
devtools::load_all()
devtools::build()
wd = "C:/Users/annal/Dropbox/IADS/dml"
setwd(wd)
wd.pack = "C:/Users/annal/Dropbox/IADS/dml/xtdml"
setwd(wd.pack)
devtools::check()
devtools::check()
devtools::build()
#______________________________________________________________________________#
# Title:  Implementation of `xtdml` with simulated data
# Date: 01 October 2025
#______________________________________________________________________________#
rm(list = ls())
wd = "C:/Users/annal/Dropbox/IADS/dml/submissions/JSS"
setwd(wd)
wd.pack = "C:/Users/annal/Dropbox/IADS/dml/xtdml" #/submissions/JSS
setwd(wd.pack)
devtools::load_all()
# Installation from CRAN
#install.packages("xtdml")
#library(xtdml)
# # # Installation from GitHub
# library(devtools)
# install_github("POLSEAN/xtdml")
# library(xtdml)
# wd.pack = "C:/Users/annal/Dropbox/IADS/dml/submissions/JSS/xtdml"
# setwd(wd.pack)
# devtools::load_all()
#______________________________________________________________________________#
# Install packages
# list.of.packages <- c("mlr3","mlr3learners","mlr3tuning","paradox","mlr3misc",
#                       "glmnet","xgboost","tibble", "dplyr","datawizard","data.table",
#                       "glue","MLmetrics","devtools","tictoc","wooldridge")
# new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
# if(length(new.packages)) install.packages(new.packages, repos = "http://cran.us.r-project.org")
library(mlr3)
library(mlr3learners)
library(paradox)
library(mlr3tuning)
library(mlr3misc)
library(glmnet)
library(xgboost)
library(nnet)
library(tibble)
library(dplyr)
library(datawizard)
library(data.table)
library(wooldridge)
library(tictoc)
# Suppress warning messages
lgr::get_logger("mlr3")$set_threshold("warn")
lgr::get_logger("bbotk")$set_threshold("warn")
#______________________________________________________________________________#
data('crime4')
yvar  = "crmrte"
dvar  = "polpc"
pvars = c("prbarr","prbconv","prbpris","avgsen")
xvars = c("density", "taxpc","west","central","urban","pctmin80",
"wcon","wtuc","wtrd","wfir","wser","wmfg","wfed","wsta","wloc",
"mix", "pctymle","d82", "d83","d84", "d85", "d86", "d87")
ln_xvars = c("lcrmrte","lprbarr","lprbconv", "lprbpris", "lavgsen", "ldensity",
"ltaxpc", "lwcon","lwtuc","lwtrd","lwfir","lwser","lwmfg",
"lwfed","lwsta","lwloc","lmix", "lpctymle", "lpctmin")
#______________________________________________________________________________#
approaches = c("fd-exact","cre", "wg-approx")
for (approach in approaches){
print(paste0("approach:", approach))
tic(paste0(approach, "-run"))
set.seed(1234)
#______________________________________________________________________________#
# gradient boosting
#______________________________________________________________________________#
obj_xtdml_data_boost = xtdml_data_from_data_frame(crime4,
x_cols = c(xvars,pvars),  y_col = yvar, d_cols = dvar,
panel_id = "county", time_id = "year",
approach = approach, transformX = "no")
print(obj_xtdml_data_boost)
learner = lrn("regr.xgboost", nrounds = 100)
ml_m = learner$clone()
ml_l = learner$clone()
xtdml_boost = xtdml_plr$new(obj_xtdml_data_boost,
ml_l = ml_l, ml_m = ml_m,
n_folds = 3,
score = "orth-PO",
dml_procedure = "dml2",
draw_sample_splitting = TRUE,
apply_cross_fitting = TRUE)
param_grid = list("ml_l" = ps(max_depth = p_int(lower = 2, upper = 10),
lambda = p_dbl(lower = 0, upper = 5)),
"ml_m" = ps(max_depth = p_int(lower = 2, upper = 10),
lambda = p_dbl(lower = 0, upper = 2)))
tune_settings = list(n_folds_tune = 3,
rsmp_tune = mlr3::rsmp("cv", folds = 3),
terminator = mlr3tuning::trm("evals", n_evals = 10),
tuner = tnr("grid_search", resolution = 10))
xtdml_boost$tune(param_set = param_grid, tune_settings = tune_settings)
xtdml_boost$fit()
#xtdml_boost$print()
xtdml_boost$summary()
#______________________________________________________________________________#
# lasso
#______________________________________________________________________________#
obj_xtdml_data_lasso = xtdml_data_from_data_frame(crime4,
x_cols = c(xvars,ln_xvars,pvars),  y_col = yvar, d_cols = dvar,
panel_id = "county", time_id = "year",
approach = approach, transformX = "poly")
#print(obj_xtdml_data_lasso)
learner = lrn("regr.cv_glmnet", s="lambda.min")
ml_m = learner$clone()
ml_l = learner$clone()
xtdml_lasso = xtdml_plr$new(obj_xtdml_data_lasso,
ml_l = ml_l, ml_m = ml_m,
score = "orth-PO",
n_folds = 3)
xtdml_lasso$fit()
#xtdml_lasso$print()
xtdml_lasso$summary()
#______________________________________________________________________________#
# nnet
#______________________________________________________________________________#
obj_xtdml_data_nnet = xtdml_data_from_data_frame(crime4,
x_cols = c(xvars,pvars),  y_col = yvar, d_cols = dvar,
panel_id = "county", time_id = "year",
approach = approach, transformX = "minmax")
print(obj_xtdml_data_nnet)
ml_l = lrn("regr.nnet", maxit=100, MaxNWts=1000, trace=FALSE)
ml_m = lrn("regr.nnet", maxit=100, MaxNWts=1000, trace=FALSE)
xtdml_nnet = xtdml_plr$new(obj_xtdml_data_nnet,
ml_l = ml_l, ml_m = ml_m,
score = "orth-PO",
n_folds = 3)
param_grid = list("ml_l" = ps(size = p_int(lower = 2, upper = 10),
decay = p_dbl(lower = 0, upper = 0.05)),
"ml_m" = ps(size = p_int(lower = 2, upper = 10),
decay = p_dbl(lower = 0, upper =  0.05)))
tune_settings = list(n_folds_tune = 3,
rsmp_tune  = mlr3::rsmp("cv", folds = 3),
terminator = mlr3tuning::trm("evals", n_evals = 10),
tuner      = tnr("grid_search", resolution = 10))
xtdml_nnet$tune(param_set = param_grid, tune_settings = tune_settings)
xtdml_nnet$fit()
#xtdml_nnet$print()
xtdml_nnet$summary()
#____________________________________________________________________________#
# Display table that compares results
#____________________________________________________________________________#
table = matrix(0, 8, 3)
table[,1] = cbind(xtdml_boost$coef_theta,
xtdml_boost$se_theta,
xtdml_boost$pval_theta,
xtdml_boost$model_rmse,
as.numeric(xtdml_boost$rmses["ml_l"]),
as.numeric(xtdml_boost$rmses["ml_m"]),
xtdml_boost$data$n_obs,
length(unique(xtdml_boost$data$data_model[[xtdml_boost$data$cluster_cols]])))
table[,2] = cbind(xtdml_lasso$coef_theta,
xtdml_lasso$se_theta,
xtdml_lasso$pval_theta,
xtdml_lasso$model_rmse,
as.numeric(xtdml_lasso$rmses["ml_l"]),
as.numeric(xtdml_lasso$rmses["ml_m"]),
xtdml_lasso$data$n_obs,
length(unique(xtdml_lasso$data$data_model[[xtdml_lasso$data$cluster_cols]])))
table[,3] = cbind(xtdml_nnet$coef_theta,
xtdml_nnet$se_theta,
xtdml_nnet$pval_theta,
xtdml_nnet$model_rmse,
as.numeric(xtdml_nnet$rmses["ml_l"]),
as.numeric(xtdml_nnet$rmses["ml_m"]),
xtdml_nnet$data$n_obs,
length(unique(xtdml_nnet$data$data_model[[xtdml_nnet$data$cluster_cols]])))
rownames(table)= c("Estimate", "Std. Error", "P-value", "Model RMSE", "MSE of l", "MSE of m",
"No. observations","No. groups")
colnames(table)= c("xtdml-Boosting", "xtdml-Lasso", "xtdml-Nnet")
print(round(table, 3))
toc()
}
#______________________________________________________________________________#
# Title:  Implementation of `xtdml` with simulated data
# Date: 01 October 2025
#______________________________________________________________________________#
rm(list = ls())
wd = "C:/Users/annal/Dropbox/IADS/dml/submissions/JSS"
setwd(wd)
wd.pack = "C:/Users/annal/Dropbox/IADS/dml/xtdml" #submissions/JSS
setwd(wd.pack)
devtools::load_all()
# Installation from CRAN
#install.packages("xtdml")
#library(xtdml)
# # Installation from GitHub
# library(devtools)
# install_github("POLSEAN/xtdml")
# library(xtdml)
#______________________________________________________________________________#
# # Install packages
# list.of.packages = c("mlr3","mlr3learners","mlr3tuning","paradox","mlr3misc",
#                       "glmnet","xgboost","tibble", "dplyr","datawizard","data.table",
#                       "glue","MLmetrics","devtools","tictoc")
# new.packages = list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
# if(length(new.packages)) install.packages(new.packages, repos = "http://cran.us.r-project.org")
library(mlr3)
library(mlr3learners)
library(paradox)
library(mlr3tuning)
library(mlr3misc)
library(xgboost)
library(tibble)
library(dplyr)
library(datawizard)
library(data.table)
library(tictoc)
# Suppress  messages
# lgr::get_logger("mlr3")$set_threshold("warn")
# lgr::get_logger("bbotk")$set_threshold("warn")
#______________________________________________________________________________#
# generate data
#______________________________________________________________________________#
set.seed(1234)
# Load data
df = make_plpr_data(n_obs = 1000, t_per = 10, dim_x = 20, theta = 0.5, rho=0.8)
approaches = "fd-exact" #c("fd-exact","cre", "wg-approx")
for (approach in approaches){
# Initialize data environment
x_cols = paste0("X", 1:20)
obj_xtdml_data = xtdml_data_from_data_frame(df,
x_cols = x_cols,  y_col = "y", d_cols = "d",
panel_id = "id", time_id = "time",
approach = approach, transformX = "no")
print(obj_xtdml_data)
#______________________________________________________________________________#
# gradient boosting
#______________________________________________________________________________#
learner = lrn("regr.xgboost", nrounds = 100)
ml_m = learner$clone()
ml_l = learner$clone()
ml_g = learner$clone()
type_score = "orth-IV" #c("orth-PO", "orth-IV")
print(paste0("approach:", approach))
for (score in type_score){
tic(paste0(score, "-run"))
if(score == "orth-PO"){
xtdml_obj = xtdml_plr$new(obj_xtdml_data,
ml_l = ml_l, ml_m = ml_m,
n_folds = 5,
score = score,
dml_procedure = "dml2",
draw_sample_splitting = TRUE,
apply_cross_fitting = TRUE)
param_grid = list("ml_l" = ps(max_depth = p_int(2,10),
lambda = p_dbl(0,2)),
"ml_m" = ps(max_depth = p_int(2,10),
lambda = p_dbl(0,2)))
}else if (score == "orth-IV"){
xtdml_obj = xtdml_plr$new(obj_xtdml_data,
ml_l = ml_l, ml_m = ml_m, ml_g = ml_g,
n_folds = 5,
score = score,
dml_procedure = "dml2",
draw_sample_splitting = TRUE,
apply_cross_fitting = TRUE)
param_grid = list("ml_l" = ps(max_depth = p_int(2,10),
lambda = p_dbl(0,2)),
"ml_m" = ps(max_depth = p_int(2,10),
lambda = p_dbl(0,2)),
"ml_g" = ps(max_depth = p_int(2,10),
lambda = p_dbl(0,2)))
}
tune_settings = list(n_folds_tune = 5,
rsmp_tune = mlr3::rsmp("cv", folds = 5),
terminator = mlr3tuning::trm("evals", n_evals = 5),
tuner        = tnr("grid_search", resolution = 10))
xtdml_obj$tune(param_set = param_grid, tune_settings = tune_settings)
# Fit DML model and print results
xtdml_obj$fit()
xtdml_obj$print()
xtdml_obj$summary()
ci = xtdml_obj$confint()
print(ci)
toc()
}
print(xtdml_obj$params)
table = matrix(0, 10, 1)
table[,1] = cbind(xtdml_obj$coef_theta,
xtdml_obj$se_theta,
xtdml_obj$pval_theta,
ci[ , 1], ci[ , 2],
xtdml_obj$model_rmse,
as.numeric(xtdml_obj$rmses["ml_l"]),
as.numeric(xtdml_obj$rmses["ml_m"]),
xtdml_obj$data$n_obs,
length(unique(xtdml_obj$data$data_model[[xtdml_obj$data$cluster_cols]])))
rownames(table)= c("Estimate", "Std. Error", "P-value", "Lower bound 95% CI", "Upper bound 95% CI",
"Model RMSE", "MSE of l", "MSE of m","No. observations","No. groups")
colnames(table)= c("xtdml-boosting")
formatted_table = matrix("", nrow=10, ncol=1)
formatted_table[1:8, 1] = formatC(table[1:8, 1], digits=4, format="f")
formatted_table[9:10, 1] = formatC(table[9:10, 1], digits=0, format="f")
# Keep row and column names
rownames(formatted_table) = rownames(table)
colnames(formatted_table) = colnames(table)
# Print
print(formatted_table, quote = FALSE)
}
devtools::check()
devtools::build()
wd.pack = "C:/Users/annal/Dropbox/IADS/dml/submissions/JSS/xtdml" #
setwd(wd.pack)
devtools::load_all()
devtools::document()
git status
